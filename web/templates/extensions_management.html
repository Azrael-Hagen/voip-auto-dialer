<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Extensiones - VoIP Auto Dialer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-phone me-2"></i>VoIP Auto Dialer
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                <a class="nav-link" href="/agents"><i class="fas fa-users me-1"></i>Agentes</a>
                <a class="nav-link" href="/providers"><i class="fas fa-network-wired me-1"></i>Proveedores</a>
                <a class="nav-link active" href="/extensions"><i class="fas fa-phone-alt me-1"></i>Extensiones</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-primary mb-1">
                            <i class="fas fa-phone-alt me-2"></i>Gestión de Extensiones
                        </h2>
                        <p class="text-muted">Administra extensiones VoIP, contraseñas y configuraciones</p>
                    </div>
                    <div>
                        <button class="btn btn-success me-2" onclick="regenerateAllPasswords()">
                            <i class="fas fa-key me-1"></i>Regenerar Contraseñas
                        </button>
                        <button class="btn btn-warning" onclick="showBulkActions()">
                            <i class="fas fa-tasks me-1"></i>Acciones Masivas
                        </button>
                    </div>
                </div>

                <!-- Estadísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-phone-alt fa-2x text-primary mb-2"></i>
                                <h4 class="text-primary" id="totalExtensions">-</h4>
                                <small class="text-muted">Total Extensiones</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h4 class="text-success" id="availableExtensions">-</h4>
                                <small class="text-muted">Disponibles</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <i class="fas fa-user-tie fa-2x text-warning mb-2"></i>
                                <h4 class="text-warning" id="assignedExtensions">-</h4>
                                <small class="text-muted">Asignadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                                <h4 class="text-info" id="utilizationRate">-</h4>
                                <small class="text-muted">Utilización</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Buscar Extensión</label>
                                <input type="text" class="form-control" id="searchExtension" placeholder="Número de extensión...">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">Todos</option>
                                    <option value="available">Disponibles</option>
                                    <option value="assigned">Asignadas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Rango</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="rangeStart" placeholder="Desde">
                                    <input type="number" class="form-control" id="rangeEnd" placeholder="Hasta">
                                    <button class="btn btn-outline-primary" onclick="filterByRange()">
                                        <i class="fas fa-filter"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Extensiones -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Lista de Extensiones
                            <span class="badge bg-primary ms-2" id="extensionCount">0</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Extensión</th>
                                        <th>Estado</th>
                                        <th>Asignado a</th>
                                        <th>Contraseña</th>
                                        <th>Servidor</th>
                                        <th>Proveedor</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="extensionsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Paginación -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Paginación dinámica -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal para editar extensión -->
    <div class="modal fade" id="editExtensionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Extensión</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editExtensionForm">
                        <input type="hidden" id="editExtensionId">
                        <div class="mb-3">
                            <label class="form-label">Nombre para mostrar</label>
                            <input type="text" class="form-control" id="editDisplayName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Servidor IP</label>
                            <input type="text" class="form-control" id="editServerIp">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proveedor</label>
                            <select class="form-select" id="editProvider">
                                <option value="local">Local</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveExtension()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allExtensions = {};
        let currentPage = 1;
        const extensionsPerPage = 50;

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadExtensionStats();
            loadExtensions();
        });

        // Cargar estadísticas
        async function loadExtensionStats() {
            try {
                const response = await fetch('/api/extensions/stats');
                const stats = await response.json();
                
                document.getElementById('totalExtensions').textContent = stats.total;
                document.getElementById('availableExtensions').textContent = stats.available;
                document.getElementById('assignedExtensions').textContent = stats.assigned;
                document.getElementById('utilizationRate').textContent = stats.utilization + '%';
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // Cargar extensiones
        async function loadExtensions() {
            try {
                const response = await fetch('/api/extensions');
                allExtensions = await response.json();
                displayExtensions();
            } catch (error) {
                console.error('Error cargando extensiones:', error);
                document.getElementById('extensionsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error cargando extensiones</td></tr>';
            }
        }

        // Mostrar extensiones en la tabla
        function displayExtensions(extensions = null) {
            const extensionsToShow = extensions || allExtensions;
            const extensionsList = Object.values(extensionsToShow);
            
            // Paginación
            const startIndex = (currentPage - 1) * extensionsPerPage;
            const endIndex = startIndex + extensionsPerPage;
            const paginatedExtensions = extensionsList.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('extensionsTableBody');
            
            if (paginatedExtensions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron extensiones</td></tr>';
                return;
            }
            
            tbody.innerHTML = paginatedExtensions.map(ext => `
                <tr>
                    <td><strong>${ext.extension}</strong></td>
                    <td>
                        <span class="badge ${ext.assigned ? 'bg-warning' : 'bg-success'}">
                            ${ext.assigned ? 'Asignada' : 'Disponible'}
                        </span>
                    </td>
                    <td>${ext.assigned_to || '-'}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="password" class="form-control" value="${ext.password}" readonly id="pwd_${ext.extension}">
                            <button class="btn btn-outline-secondary" onclick="togglePassword('${ext.extension}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td><small class="text-muted">${ext.server_ip}</small></td>
                    <td><span class="badge bg-secondary">${ext.provider}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editExtension('${ext.extension}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="regeneratePassword('${ext.extension}')" title="Nueva contraseña">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="showSoftphoneConfig('${ext.extension}')" title="Configuración">
                                <i class="fas fa-cog"></i>
                            </button>
                            ${ext.assigned ? `
                                <button class="btn btn-outline-warning" onclick="releaseExtension('${ext.extension}')" title="Liberar">
                                    <i class="fas fa-unlock"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('extensionCount').textContent = extensionsList.length;
            updatePagination(extensionsList.length);
        }

        // Alternar visibilidad de contraseña
        function togglePassword(extensionId) {
            const input = document.getElementById(`pwd_${extensionId}`);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Regenerar contraseña
        async function regeneratePassword(extensionId) {
            if (!confirm(`¿Regenerar contraseña para extensión ${extensionId}?`)) return;
            
            try {
                const response = await fetch(`/api/extensions/${extensionId}/regenerate-password`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadExtensions();
                    loadExtensionStats();
                    alert('Contraseña regenerada exitosamente');
                } else {
                    alert('Error regenerando contraseña');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error regenerando contraseña');
            }
        }

        // Liberar extensión
        async function releaseExtension(extensionId) {
            if (!confirm(`¿Liberar extensión ${extensionId}?`)) return;
            
            try {
                const response = await fetch(`/api/extensions/${extensionId}/release`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadExtensions();
                    loadExtensionStats();
                    alert('Extensión liberada exitosamente');
                } else {
                    alert('Error liberando extensión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error liberando extensión');
            }
        }

        // Filtros
        document.getElementById('searchExtension').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filtered = Object.fromEntries(
                Object.entries(allExtensions).filter(([key, ext]) => 
                    ext.extension.toLowerCase().includes(searchTerm)
                )
            );
            currentPage = 1;
            displayExtensions(filtered);
        });

        document.getElementById('filterStatus').addEventListener('change', function() {
            const status = this.value;
            if (!status) {
                displayExtensions();
                return;
            }
            
            const filtered = Object.fromEntries(
                Object.entries(allExtensions).filter(([key, ext]) => 
                    status === 'assigned' ? ext.assigned : !ext.assigned
                )
            );
            currentPage = 1;
            displayExtensions(filtered);
        });

        // Paginación
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / extensionsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Botón anterior
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>
                </li>
            `;
            
            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Botón siguiente
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Siguiente</a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            if (page < 1) return;
            currentPage = page;
            displayExtensions();
        }
    </script>
</body>
</html>
